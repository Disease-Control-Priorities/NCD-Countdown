---
title: "NCD_countdown_costing"
author: "Yoshito Kawakatsu"
date: "2020年4月13日"
output: html_document
---

# Install the package
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls()) #Remove all
library(dplyr)
library(ggplot2)
library(readxl)
#library(tidyverse)
library(kableExtra)
library(reshape2)
library(stringr)

'%!in%' <- function(x,y)!('%in%'(x,y))
```

# Functions
```{r}
tradable_conversion <- function(unit_cost, tradable_ratio, currency, global_inflation, exchange){
  if(currency == "USD") {
    unit_cost*tradable_ratio*global_inflation} else {
      ((unit_cost*tradable_ratio)/exchange)*global_inflation
    }
}

nontradable_conversion <- function(unit_cost,tradable_ratio, currency, cpi_adjust, exchange,country, exchange_end, gni, gni_selected_country){
  if(currency == "USD" & (country == "LIC" | country == "LMIC" | country == "LIC+LMIC+UMIC")) {
    unit_cost*(1-tradable_ratio)*cpi_adjust*(gni_selected_country/gni)
  } else if (currency == "USD" & (country != "LIC" & country != "LMIC" & country != "LIC+LMIC+UMIC")){
    ((unit_cost*exchange)*(1-tradable_ratio))*cpi_adjust/exchange_end*(gni_selected_country/gni)} 
  else {
      ((unit_cost*(1-tradable_ratio)*cpi_adjust)/exchange_end)*(gni_selected_country/gni)
    }
}
```

# Install the necessary input files
```{r}
# Unit cost adjustment
uc <- read.csv("NCD_data_0706/PINandCosts2.csv", stringsAsFactors=F)
uc$NCD <- as.character(uc$NCD)
uc[uc$Intervention == "Depression chronic treatment",]$NCD <- "2.10"

uc$unique_id <- paste0("C",uc$NCD,"_",uc$sub_id)



#table(uc$unique_id)
uc <- uc %>% 
  rename(Original.Currency = "Original.Currency",
         Original.Unit.Cost = "Original.Unit.Cost"
         ) %>% 
  filter(Original.Currency != "NA")

# Necessary files
# Exchange rate
exchange <- read_xlsx("NCD_data_0706/Exchange_rate.xlsx")

# Regional inflation
regional_inflation <- read_xls("NCD_data_0706/Regional_inflation_20200212.xls", sheet = "Data")
regional_inflation[,c(5:64)] <- (regional_inflation[,c(5:64)]/100)+1

# COUntry grouping
class <- read.csv("NCD_data_0706/Country_groupings.csv")

#Country list: only eligible countries
table(class$NCD_region)
country_list <- class %>% 
  filter(World_bank == "LIC" | World_bank == "LMIC"| World_bank == "UMIC") %>% 
  filter(NCD_region %in% c("Latin America and Caribbean",
         "Central and Eastern Europe",
         "Central Asia, Middle East and North Africa",
         "Sub-Saharan Africa",
         "South Asia",
         "East and South East Asia",
         "Oceania")) %>% 
  select(World_bank, NCD_region ,Country, iso3)


# CPI adjusted
cpi <- read.csv("CPI_adjustment/CPI_WB_2018_added2.csv", stringsAsFactors=F)

# GNI
GNI <- read.csv("GNI_adjustment/GNI_WB_USD_2017_re2.csv", stringsAsFactors=F)
#GNI[GNI$Country == "Syria",]

# population in need
load("NCD_data_0706/icer_rank_output.rda")

```

# Check pop & death data from Will
```{r}
head(all.pin)
head(all.dalys)

all.pin$unique_id <- paste0(all.pin$Code,"_",all.pin$sub_id)

write.csv(all.pin, "NCD_data_0706/From Will/pin_all_icer.csv")
write.csv(all.dalys, "NCD_data_0706/From Will/NCD_benefits_icer.csv")

all.pin.icer <- all.pin
benefits <- merge(y = all.dalys, x = class, by.x = "Country", by.y = "location_name")
```

# Settings
```{r}
#Setting
#tradable_ratio <- 0.3
UC_Years <- 2017  # The output year
# ancillary_HF_cost <- 0.5 # possible change
# above_HF <- 0.17 # possible change
```

# Data frame
```{r}
final_all <- data.frame(Code = character() ,
                        adjusted_uc = numeric(),
                        pin_sum= numeric(),
                        year_id =  numeric(),
                        total_cost = numeric(),
                        senario = character() ,
                        Country = character(),
                        Class = character(),
                        Region = character(),
                        stringsAsFactors=FALSE)


final_all_intervention <- data.frame(Code = character(),
                                     Intervention = character(),
                                     senario = character() ,
                                     Country = character(),
                                     adjusted_uc = numeric(),
                                     pin_sum = numeric(),
                                     total_cost = numeric(),
                                     Region = character(),
                                     stringsAsFactors=FALSE) 




final_all_ICER <- data.frame(Code = character(),
                             Intervention = character(),
                             Country = character(),
                             adjusted_uc = numeric(),
                             pin_sum = numeric(),
                             total_cost = numeric(),
                             pin_sum_adjusted = numeric(),
                             total_cost_adjusted = numeric(),
                             increment = numeric(),
                             Super_region = character(),
                             NCD_region = character(),
                             SDI = character(),
                             World_bank = character(),
                             iso3 = character(),
                             period = character(),
                             life_years_gained = numeric(),
                             deaths_averted = numeric(),
                             ICER = numeric(),
                             ICER_rank = numeric()
)

increment_all_year      <- data.frame(
                             unique_id = character(),
                             year_id = numeric(),
                             Class = character(),
                             Region = character(),
                             adjusted_uc = numeric(),
                             base_pin = numeric(),
                             base_total = numeric(),
                             adjust_pin = numeric(),
                             adjust_total = numeric(),
                             increment = numeric()
)

```

# Calculate adjusted costs & total by interventions
```{r}
i <- 1
c <- 1
n <- 1
y <- 1


for (c in 1:nrow(country_list)){
 
  selected_country <- as.character(country_list$Country[c])
  selected_country_code <- as.character(country_list$iso3[c])
  selected_country_category <- as.character(country_list$World_bank[c])
  selected_country_region <- as.character(country_list$NCD_region[c])

#Adjusted UC start------------------------------------------
# Adjustment database
    no <- nrow(uc)
    
    adjustment <- data.frame(ID = 1:no, 
                             country = NA, 
                             year = NA, 
                             n = NA, 
                             cpi_study = NA, cpi_end = NA, cpi_adjust = NA,
                             global_inflation = NA,
                             exchange = NA,
                             exchange_end = NA, 
                             #gni_selected_country = NA,
                             gni = NA)

    
    for (i in 1:no){
      
      #Country
      country <- as.character(uc[i,"Country"])
      adjustment[i,"country"] <- country
      
      #Original UC_Year
      year <- uc[i,"Year"]
      adjustment[i,"year"] <- year
      
      # Exchange of original UC
      n <- as.numeric(year) - 1960 +2
      end_year <- as.numeric(UC_Years - 1960 +2)
      
      
      adjustment[i,"n"] <- n
      adjustment[i,"exchange"] <- as.numeric(exchange[exchange$Country == country, n])
      
      # Exchange rate in 2017
      adjustment[i,"exchange_end"] <- as.numeric(exchange[exchange$Country == country, end_year])
      
      # consumer price index
      study_year <- as.numeric(year) - 1960 + 6
      end_year <- as.numeric(UC_Years - 1960 + 6)
      
      adjustment[i,"cpi_study"] <- as.numeric(cpi[cpi$Country == country, study_year])
      adjustment[i,"cpi_end"] <- as.numeric(cpi[cpi$Country == country, end_year])
      
      # Global inflation calculation
      col_n <- as.numeric(year) - 1960+5
      col_end <- as.numeric(UC_Years) - 1960+5
      
      adjustment[i,"global_inflation"] <-
        as.numeric(prod(as.matrix(regional_inflation[regional_inflation$Country == "World", col_n:col_end])))
      
      #GNI
      GNI_year <- UC_Years - 1960 +7
      adjustment[i,"gni"] <- as.numeric(GNI[GNI$Country == country, GNI_year])
      
      # adjustment[i,"gni"] <- ifelse(selected_country_category == "UMIC", 
      #                               as.numeric(GNI[GNI$Country == "UMIC", GNI_year]),
      #                               adjustment[i,"gni"])
      
      
    }
    
      # adjustment$gni <- ifelse(adjustment$country == "LMIC", 
      #                            as.numeric(GNI[GNI$Country == "UMIC", GNI_year]),
      #                              adjustment$gni)
    
    # GNI adjustment
    adjustment$gni_selected_country <- as.numeric(GNI[GNI$Country.Code == selected_country_code, GNI_year])
    adjustment$gni_adjust <- adjustment$gni_selected_country/ adjustment$gni
    
    # CPI adjustment rate
    adjustment[,"cpi_adjust"] <- adjustment$cpi_end / adjustment$cpi_study
    
    # Merge adjustments with uc
    ucm <- cbind(uc, adjustment)
    
    # Tradable
    ucm$tradable_ratio <- ucm$Traded

    ucm$tradable_uc <- NA
    for (i in 1:no){

        ucm$tradable_uc[i] <- tradable_conversion(
                               unit_cost = as.numeric(ucm$Original.Unit.Cost[i]),
                               tradable_ratio = ucm$tradable_ratio[i],
                               currency = ucm$Original.Currency[i],
                               global_inflation = ucm$global_inflation[i],
                               exchange = as.numeric(ucm$exchange[i]))
                    }
    
    ucm$nontradable_uc <- NA    
     for (i in 1:no){
      ucm$nontradable_uc[i] <- nontradable_conversion(
                               unit_cost = as.numeric(ucm$Original.Unit.Cost[i]),
                               tradable_ratio = ucm$tradable_ratio[i],
                               currency = ucm$Original.Currency[i],
                               cpi_adjust = ucm$cpi_adjust[i],
                               country = ucm$country[i],
                               exchange = ucm$exchange[i],
                               exchange_end = ucm$exchange_end[i],
                               gni = ucm$gni[i],
                               gni_selected_country = ucm$gni_selected_country[i])
                    }
    
    # Add ancillary + above HF costs

     ucm$adjusted_uc <- (ucm$tradable_uc + ucm$nontradable_uc)*(ucm$Cost.adjustment)

     # Class check
     country_class <- as.character(country_list[country_list$Country == selected_country,]$World_bank)
     
     adjusted_uc <- if(country_class == "LIC"){
              ucm %>% 
                filter(unique_id != "C4.1_a")
     } else {
              ucm
     }

     # Output: adjusted unit cost
     file.name <- paste0("Result_0706/UC/",selected_country,"_adjusted_uc_",UC_Years,".csv")
     write.csv(adjusted_uc, file.name)

     # Merge interventions costs
     adjusted_uc_sum <- adjusted_uc %>% group_by(NCD) %>% 
       summarize(adjusted_uc = sum(adjusted_uc))
     
     # Output: adjusted & merged unit cost
     file.name <- paste0("Result_0706/UC/",selected_country,"_adjusted_uc_merged_",UC_Years,".csv")
     write.csv(adjusted_uc_sum, file.name)     
        
# Adjusted UC end ------------------------------------------
     
    result.df <- adjusted_uc %>% select(unique_id)
    result.df2 <- adjusted_uc %>% select(unique_id)

    
# full data -----------------------
  country.pop <- all.pin.icer %>% 
  filter(location_name == selected_country)
    
  full.data <- merge.data.frame(x = country.pop, y = adjusted_uc[,c("unique_id", "Original.Unit.Cost", "Cost.adjustment", "Traded", "tradable_uc", "nontradable_uc", "adjusted_uc" )], by = "unique_id", all.x = T)

  full.data$total_cost <- full.data$pin * full.data$adjusted_uc
  
  file.name <- paste0("Result_0706/All_pop_cost/",selected_country,"_all_by_intervention_year",".csv")
  write.csv(full.data, file.name)
  
    
# Baseline population in need------------------
for (y in 0:10){
  
##PIN by intervention
# pin_group = all code
pin_group <- all.pin.icer %>% 
  filter(location_name == selected_country,
         year_id == 2020 + y, 
         group == "Baseline") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

pin_group$year_id <- 2020 + y

uc_pin <- merge.data.frame(adjusted_uc, pin_group, by = "unique_id")

uc_pin <- uc_pin %>% 
  mutate(total_cost = adjusted_uc * pin_sum)

uc_pin_all <- if(y == 0) {
  uc_pin
} else {
  rbind(uc_pin_all, uc_pin)
}

result.df <- merge(result.df, uc_pin[,c("unique_id","total_cost")], by = "unique_id")

label <- paste0("cost_",2020+y)
names(result.df)[ which( names(result.df)=="total_cost" ) ] <- label
}

  
# By Interventions
final.df1_int <- result.df
final.df1_int$senario <- "Baseline"
final.df1_int$Country <- selected_country
final.df1_int$Class <- country_class
final.df1_int$Region <- selected_country_region

final.df1_int$total_cost <- apply(final.df1_int[,2:12],1,sum)

# Add unit cost
final.df1_int <- merge(final.df1_int, uc_pin[,c("unique_id", "adjusted_uc")] , by = "unique_id")

# Add pin
pin_code <- all.pin.icer %>% 
  filter(location_name == selected_country,
         group == "Baseline") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

final.df1_int <- merge(final.df1_int, pin_code[,c("unique_id", "pin_sum")], by = "unique_id")

 # final.df1_int <- final.df1_int %>%
 #   select(unique_id, senario, Country, adjusted_uc, pin_sum ,total_cost, Region)
 # 

# years
result.df1_long <- uc_pin_all

result.df1_long$senario <- "Baseline"
result.df1_long$Country <- selected_country
result.df1_long$Class <- country_class
result.df1_long$Region <- selected_country_region





#Adjustment-------------

for (y in 0:10){
#PIN by intervention

# pin_group = all code
pin_group <- all.pin.icer %>% 
  filter(location_name == selected_country,
         year_id == 2020 + y, 
         group == "Adjusted") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

pin_group$year_id <- 2020 + y

uc_pin <- merge.data.frame(adjusted_uc, pin_group, by = "unique_id")

uc_pin <- uc_pin %>% 
  mutate(total_cost = adjusted_uc * pin_sum)

uc_pin_all <- if(y == 0) {
  uc_pin
} else {
  rbind(uc_pin_all, uc_pin)
}

result.df2 <- merge(result.df2, uc_pin[,c("unique_id","total_cost")], by = "unique_id")

label <- paste0("cost_",2020+y)
names(result.df2)[ which( names(result.df2)=="total_cost" ) ] <- label

}

# By intervention & save

final.df2_int <- result.df2
final.df2_int$senario <- "Adjusted"
final.df2_int$Country <- selected_country
final.df2_int$Class <- country_class
final.df2_int$Region <- selected_country_region

final.df2_int$total_cost <- apply(final.df2_int[,2:12],1,sum)

# Add unit cost
final.df2_int <- merge(final.df2_int, uc_pin[,c("unique_id", "adjusted_uc")])

# Add pin
pin_code <- all.pin.icer %>% 
  filter(location_name == selected_country, 
         group == "Adjusted") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

final.df2_int <- merge(final.df2_int, pin_code[,c("unique_id", "pin_sum")])

# 
#  final.df2_int <- final.df2_int %>% 
#    select(Code, senario, Country, adjusted_uc, pin_sum ,total_cost, Region)
  
final_country_tc_int <- rbind(final.df1_int,final.df2_int)


#Final dataset by interventions-------------------
file.name <- paste0("Result_0706/Total_cost_intervention/",selected_country,"_total_cost_2030_intervention",".csv")
write.csv(final_country_tc_int, file.name)

final_all_intervention <- rbind(final_all_intervention, final_country_tc_int)
#--------------------------------------------------

# By year
result.df2_long <- uc_pin_all

result.df2_long$senario <- "Adjusted"
result.df2_long$Country <- selected_country
result.df2_long$Class <- country_class
result.df2_long$Region <- selected_country_region

# Save
final_country_tc3 <- rbind(result.df1_long,result.df2_long)
file.name <- paste0("Result_0706/Total_cost_year/",selected_country,"_total_cost_2030",".csv")
write.csv(final_country_tc3, file.name)

#Final dataset-------------------
  final_all <- rbind(final_all, final_country_tc3)

# ----------------------
# incremental cost by year and intervention
base_result <- result.df1_long %>% 
  filter(senario == "Baseline")%>% 
  select(unique_id, Country, Class, Region, year_id, adjusted_uc, pin_sum, total_cost) %>% 
  rename(base_pin = pin_sum,
         base_total = total_cost) 

adjust_result <- result.df2_long %>%
  filter(senario == "Adjusted") %>% 
  select(unique_id, year_id, pin_sum, total_cost) %>% 
  rename(adjust_pin = pin_sum,
         adjust_total = total_cost) 


increment_by_year <- merge(base_result, adjust_result , by = c("unique_id", "year_id"))

increment_by_year$incremental <- increment_by_year$adjust_total - increment_by_year$base_total

file.name <- paste0("Result_0706/incremental_cost_year/",selected_country,"_increment_cost_2020_2030",".csv")
write.csv(increment_by_year, file.name)

increment_all_year <- rbind(increment_all_year, increment_by_year)

# ICER calculation
#  final.df2_int2 <- final.df2_int %>% 
#    rename(pin_sum_adjusted = pin_sum,
#           total_cost_adjusted = total_cost) %>% 
#    select(unique_id, senario, pin_sum_adjusted, total_cost_adjusted)
#  
# country.all <- merge(final.df1_int,final.df2_int2, by = "unique_id")
# country.all$increment <- country.all$total_cost_adjusted - country.all$total_cost


country.all.id <- colsplit(increment_by_year$unique_id,"_",names=c("Code","sub_id"))
# From unique_id to Code
increment_by_year$Code <- country.all.id$Code
increment_by_year$sub_id <- country.all.id$sub_id


country.all.sum <- increment_by_year %>% 
  group_by(Code,year_id) %>% 
  summarize(sum_increment = sum(incremental))


# Benefit
benefits.country <- benefits %>% 
  filter(Country == selected_country) %>% 
  select(-Region, -Country) %>% 
  group_by(Code, year_id) %>% 
  summarize(sum_ly = sum(DALY.ave))

country.all2 <- merge(x = country.all.sum, y = benefits.country, by = c("Code", "year_id"),all.x = T)

country.all2$Country <- selected_country

country.all2 <- country.all2 %>% 
  mutate(ICER = sum_increment / sum_ly
         )

file.name <- paste0("Result_0706/ICER_country_detail/",selected_country,"_ICER_2020_2030",".csv")
write.csv(country.all2, file.name)


country.all3 <- country.all2 %>% 
  group_by(Code) %>% 
  summarise(sum_increment_all = sum(sum_increment),
            sum_ly_all = sum(sum_ly)) %>% 
  mutate(
    ICER = sum_increment_all / sum_ly_all,
    ICER_rank = rank(ICER)
  ) %>% 
  mutate(
    Country = selected_country,
    NCD_region = selected_country_region,
    World_bank = selected_country_category,
    iso3 = selected_country_code
  )

file.name <- paste0("Result_0706/ICER_country/",selected_country,"_ICER_2030",".csv")
write.csv(country.all3, file.name)

final_all_ICER <- rbind(final_all_ICER, country.all3)

}
```


# All data saved
```{r}
file.name <- paste0("Result_0706/All/All_total_cost_2030_intervention",".csv")
write.csv(final_all_intervention, file.name)

file.name <- paste0("Result_0706/All/All_total_cost_2030_year",".csv")
write.csv(final_all, file.name)

file.name <- paste0("Result_0706/All/All_ICER_2030",".csv")
write.csv(final_all_ICER, file.name)

file.name <- paste0("Result_0706/All/All_increment_2030",".csv")
write.csv(increment_all_year, file.name)

```

# clean up: intervention by year: pop
```{r}
head(increment_all_year)
head(final_all)

# mean unit costs by intervention and class
df.uc <- increment_all_year %>% 
  group_by(Country, unique_id, Class) %>% 
  summarize(mean_uc = mean(adjusted_uc)) 

df.uc.class <- df.uc%>% 
  group_by(unique_id, Class) %>% 
  summarize(mean_uc_final = mean(mean_uc))

df.uc.class_wide <- spread(data = df.uc.class, key = Class, value = mean_uc_final)

write.csv(df.uc.class_wide, "Result_0706/All/Mean_UC.csv")

# Population by years and senario
base_pin_df <- increment_all_year %>% 
  group_by(unique_id, year_id) %>% 
  summarize(sum_base_pin = sum(base_pin))

base_pin_df_wide <- spread(data = base_pin_df, key = year_id, value = sum_base_pin)
write.csv(base_pin_df_wide, "Result_0706/All/Baseline_pop.csv")

# adjusted
adjust_pin_df <- increment_all_year %>% 
  group_by(unique_id, year_id) %>% 
  summarize(sum_base_pin = sum(adjust_pin))

adjust_pin_df_wide <- spread(data = adjust_pin_df, key = year_id, value = sum_base_pin)
write.csv(adjust_pin_df_wide, "Result_0706/All/Adjusted_pop.csv")

# Incremental
increment_df <- increment_all_year %>% 
  group_by(unique_id, year_id) %>% 
  summarize(sum_increment = sum(incremental))

increment_df_wide <- spread(data = increment_df, key = year_id, value = sum_increment)
write.csv(increment_df_wide, "Result_0706/All/Incremental_cost.csv")

```


# Check output
```{r}
icer <- read.csv("Result_0706/All/All_ICER_2030.csv" , stringsAsFactors=F)

codes <- colsplit(icer$Code, ".", names = c("NCD","sub_id"))
icer$NCD <- codes$NCD

#Check
file.name <- paste0("Result_0706/All/All_ICER_2030_re.csv")
write.csv(icer, file.name)

icer.sum <- icer %>% 
              group_by(NCD) %>%
              summarize(total_increment = sum(sum_increment_all),
                        total_life_year = sum(sum_ly_all))

file.name <- paste0("Result_0706/All/All_increment_ly_sum",".csv")
write.csv(icer.sum, file.name)


icer.sum <- icer %>% 
              group_by(Code) %>%
              summarize(total_increment = sum(sum_increment_all),
                        total_life_year = sum(sum_ly_all))

file.name <- paste0("Result_0706/All/All_increment_ly_sum_re",".csv")
write.csv(icer.sum, file.name)

```


# Figure 2
```{r ICER}
icer <- read.csv("Result_0706/All/All_ICER_2030_re.csv", stringsAsFactors=F)
self_harm <- c("C2.9", "C2.10", "C2.11", "C2.12")

# By region
icer.int <- icer %>%
                group_by(Code, NCD_region) %>%
                summarize(
                  total_ly_gained = sum(sum_ly_all),
                  total_increment = sum(sum_increment_all))

icer.int$icer <- icer.int$total_increment / icer.int$total_ly_gained

library(reshape2)
ly_wide <- dcast(data = icer.int, formula = Code ~ NCD_region,
                 value.var = "icer")

ly_wide2 <- ly_wide %>% 
  filter(Code %!in%  self_harm) %>% 
  select(Code, 
         "Latin America and Caribbean",
         "Central and Eastern Europe",
         "Central Asia, Middle East and North Africa",
         "Sub-Saharan Africa",
         "South Asia",
         "East and South East Asia",
         "Oceania"
         )

write.csv(ly_wide2, "Result_0706/Impact/ICER_region_NCD.csv")


ly_wide2 <- ly_wide %>% 
  filter(Code %in%  self_harm) %>% 
  select(Code, 
         "Latin America and Caribbean",
         "Central and Eastern Europe",
         "Central Asia, Middle East and North Africa",
         "Sub-Saharan Africa",
         "South Asia",
         "East and South East Asia",
         "Oceania"
         )

write.csv(ly_wide2, "Result_0706/Impact/ICER_region_self_harm.csv")
```

```{r ICER ranking}

icer.int2 <- icer.int %>% group_by(NCD_region) %>% 
  filter(Code %!in%  self_harm) %>% 
  mutate(rank = rank(icer))

rank_wide <- dcast(data = icer.int2, formula = Code ~ NCD_region,
                 value.var = "rank")

rank_wide <- rank_wide %>% 
  select(Code, 
         "Latin America and Caribbean",
         "Central and Eastern Europe",
         "Central Asia, Middle East and North Africa",
         "Sub-Saharan Africa",
         "South Asia",
         "East and South East Asia",
         "Oceania"
         )

write.csv(rank_wide, "Result_0706/Impact/Rank_region_NCD.csv")


# Self harm
icer.int2 <- icer.int %>% group_by(NCD_region) %>% 
  filter(Code %in% self_harm ) %>% 
  mutate(rank = rank(icer))

rank_wide <- dcast(data = icer.int2, formula = Code ~ NCD_region,
                 value.var = "rank")

rank_wide <- rank_wide %>% 
  select(Code, 
         "Latin America and Caribbean",
         "Central and Eastern Europe",
         "Central Asia, Middle East and North Africa",
         "Sub-Saharan Africa",
         "South Asia",
         "East and South East Asia",
         "Oceania"
         )

write.csv(rank_wide, "Result_0706/Impact/Rank_region_self_harm.csv")

table(icer.int$Code)
```

```{r ICER percent}
gdp <- read.csv("GDP_per_capita_2017/GDP_per_2017_NCD_region_0608.csv")


gdp <- gdp %>% 
  select(NCD_region, GDP_2017_capita)

icer_long_gdp <- merge(gdp, icer.int,  by.x = "NCD_region", by.y = "NCD_region", all.y = T)

# Variable generate
icer_long_gdp$ICER_percent <-  icer_long_gdp$icer / icer_long_gdp$GDP_2017_capita

#Wide
percent_wide <- dcast(data = icer_long_gdp, formula = Code ~ NCD_region,
                 value.var = "ICER_percent")

# Re-arrange
percent_wide2 <- percent_wide %>% 
  filter(Code %!in%  self_harm) %>% 
  select(Code, 
         "Latin America and Caribbean",
         "Central and Eastern Europe",
         "Central Asia, Middle East and North Africa",
         "Sub-Saharan Africa",
         "South Asia",
         "East and South East Asia",
         "Oceania"
         )
# Save
write.csv(percent_wide2, "Result_0706/Impact/Percent_region_NCD.csv")


percent_wide2 <- percent_wide %>% 
  filter(Code %in%  self_harm) %>%
  select(Code, 
         "Latin America and Caribbean",
         "Central and Eastern Europe",
         "Central Asia, Middle East and North Africa",
         "Sub-Saharan Africa",
         "South Asia",
         "East and South East Asia",
         "Oceania"
         )
# Save
write.csv(percent_wide2, "Result_0706/Impact/Percent_region_self_harm.csv")
```






# Table2 (NCD interventions): Based on ICER ranking
```{r data install}
load("NCD_data_0706/Optim.Out.rda")
# Data check
all.pin.opt
dalys.opt

all.pin.opt$unique_id <- paste0(all.pin.opt$Code,"_",all.pin.opt$sub_id)

write.csv(all.pin.opt, "NCD_data_0706/From Will/pin_all_opt.csv")
write.csv(dalys.opt, "NCD_data_0706/From Will/NCD_benefits_opt.csv")

benefits.opt <- merge(y = dalys.opt, x = class, by.x = "Country", by.y = "location_name")
```

```{r data.frame development}
final_all <- data.frame(Code = character() ,
                        adjusted_uc = numeric(),
                        pin_sum= numeric(),
                        year_id =  numeric(),
                        total_cost = numeric(),
                        senario = character() ,
                        Country = character(),
                        Class = character(),
                        Region = character(),
                        stringsAsFactors=FALSE)


final_all_intervention <- data.frame(Code = character(),
                                     Intervention = character(),
                                     senario = character() ,
                                     Country = character(),
                                     adjusted_uc = numeric(),
                                     pin_sum = numeric(),
                                     total_cost = numeric(),
                                     Region = character(),
                                     stringsAsFactors=FALSE) 




final_all_ICER <- data.frame(Country = character(),
                             year_id = numeric(),
                             Region = character(),
                             sum_increment = numeric(),
                             life_years_gained = numeric(),
                             ICER = numeric()
)

increment_all_year      <- data.frame(
                             unique_id = character(),
                             year_id = numeric(),
                             Class = character(),
                             Region = character(),
                             adjusted_uc = numeric(),
                             base_pin = numeric(),
                             base_total = numeric(),
                             adjust_pin = numeric(),
                             adjust_total = numeric(),
                             increment = numeric()
)
```


```{r re-run}
# Calculate adjusted costs & total by interventions
i <- 1
c <- 1
n <- 1
y <- 1

UC_Years <- 2017  # The output year

for (c in 1:nrow(country_list)){
 
  selected_country <- as.character(country_list$Country[c])
  selected_country_code <- as.character(country_list$iso3[c])
  selected_country_category <- as.character(country_list$World_bank[c])
  selected_country_region <- as.character(country_list$NCD_region[c])
  
  country_class <- as.character(country_list[country_list$Country == selected_country,]$World_bank) 
# Adjusted UC install
# Adjustment database
  no <- nrow(uc)

  file.name <- paste0("Result_0706/UC/",selected_country,"_adjusted_uc_",UC_Years,".csv")
  adjusted_uc <- read.csv(file.name)
        
# Adjusted UC end 
     
    result.df <- adjusted_uc %>% select(unique_id)
    result.df2 <- adjusted_uc %>% select(unique_id)

    
# full data -----------------------
  country.pop <- all.pin.opt %>% 
  filter(location_name == selected_country)
    
  full.data <- merge.data.frame(x = country.pop, y = adjusted_uc[,c("unique_id", "Original.Unit.Cost", "Cost.adjustment", "Traded", "tradable_uc", "nontradable_uc", "adjusted_uc" )], by = "unique_id", all.x = T)

  full.data$total_cost <- full.data$pin * full.data$adjusted_uc
  
  file.name <- paste0("Result_0706/Optimal/All_pop_cost/",selected_country,"_all_by_intervention_year",".csv")
  write.csv(full.data, file.name)
  
    
# Baseline population in need------------------
for (y in 0:10){
  
##PIN by intervention
# pin_group = all code
pin_group <- all.pin.opt %>% 
  filter(location_name == selected_country,
         year_id == 2020 + y, 
         group == "Baseline") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

pin_group$year_id <- 2020 + y

uc_pin <- merge.data.frame(adjusted_uc, pin_group, by = "unique_id")

uc_pin <- uc_pin %>% 
  mutate(total_cost = adjusted_uc * pin_sum)

uc_pin_all <- if(y == 0) {
  uc_pin
} else {
  rbind(uc_pin_all, uc_pin)
}

result.df <- merge(result.df, uc_pin[,c("unique_id","total_cost")], by = "unique_id")

label <- paste0("cost_",2020+y)
names(result.df)[ which( names(result.df)=="total_cost" ) ] <- label
}

  
# By Interventions
final.df1_int <- result.df
final.df1_int$senario <- "Baseline"
final.df1_int$Country <- selected_country
final.df1_int$Class <- country_class
final.df1_int$Region <- selected_country_region

final.df1_int$total_cost <- apply(final.df1_int[,2:12],1,sum)

# Add unit cost
final.df1_int <- merge(final.df1_int, uc_pin[,c("unique_id", "adjusted_uc")] , by = "unique_id")

# Add pin
pin_code <- all.pin.opt %>% 
  filter(location_name == selected_country,
         group == "Baseline") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

final.df1_int <- merge(final.df1_int, pin_code[,c("unique_id", "pin_sum")], by = "unique_id")

 # final.df1_int <- final.df1_int %>%
 #   select(unique_id, senario, Country, adjusted_uc, pin_sum ,total_cost, Region)
 # 

# years
result.df1_long <- uc_pin_all

result.df1_long$senario <- "Baseline"
result.df1_long$Country <- selected_country
result.df1_long$Class <- country_class
result.df1_long$Region <- selected_country_region





#Adjustment-------------

for (y in 0:10){
#PIN by intervention

# pin_group = all code
pin_group <- all.pin.opt %>% 
  filter(location_name == selected_country,
         year_id == 2020 + y, 
         group == "Adjusted") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

pin_group$year_id <- 2020 + y

uc_pin <- merge.data.frame(adjusted_uc, pin_group, by = "unique_id")

uc_pin <- uc_pin %>% 
  mutate(total_cost = adjusted_uc * pin_sum)

uc_pin_all <- if(y == 0) {
  uc_pin
} else {
  rbind(uc_pin_all, uc_pin)
}

result.df2 <- merge(result.df2, uc_pin[,c("unique_id","total_cost")], by = "unique_id")

label <- paste0("cost_",2020+y)
names(result.df2)[ which( names(result.df2)=="total_cost" ) ] <- label

}

# By intervention & save

final.df2_int <- result.df2
final.df2_int$senario <- "Adjusted"
final.df2_int$Country <- selected_country
final.df2_int$Class <- country_class
final.df2_int$Region <- selected_country_region

final.df2_int$total_cost <- apply(final.df2_int[,2:12],1,sum)

# Add unit cost
final.df2_int <- merge(final.df2_int, uc_pin[,c("unique_id", "adjusted_uc")])

# Add pin
pin_code <- all.pin.opt %>% 
  filter(location_name == selected_country, 
         group == "Adjusted") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

final.df2_int <- merge(final.df2_int, pin_code[,c("unique_id", "pin_sum")])

# 
#  final.df2_int <- final.df2_int %>% 
#    select(Code, senario, Country, adjusted_uc, pin_sum ,total_cost, Region)
  
final_country_tc_int <- rbind(final.df1_int,final.df2_int)


#Final dataset by interventions-------------------
file.name <- paste0("Result_0706/Optimal/Total_cost_intervention/",selected_country,"_total_cost_2030_intervention",".csv")
write.csv(final_country_tc_int, file.name)

final_all_intervention <- rbind(final_all_intervention, final_country_tc_int)
#--------------------------------------------------

# By year
result.df2_long <- uc_pin_all

result.df2_long$senario <- "Adjusted"
result.df2_long$Country <- selected_country
result.df2_long$Class <- country_class
result.df2_long$Region <- selected_country_region

# Save
final_country_tc3 <- rbind(result.df1_long,result.df2_long)
file.name <- paste0("Result_0706/Optimal/Total_cost_year/",selected_country,"_total_cost_2030",".csv")
write.csv(final_country_tc3, file.name)

#Final dataset-------------------
  final_all <- rbind(final_all, final_country_tc3)

# ----------------------
# incremental cost by year and intervention
base_result <- result.df1_long %>% 
  filter(senario == "Baseline")%>% 
  select(unique_id, Country, Class, Region, year_id, adjusted_uc, pin_sum, total_cost) %>% 
  rename(base_pin = pin_sum,
         base_total = total_cost) 

adjust_result <- result.df2_long %>%
  filter(senario == "Adjusted") %>% 
  select(unique_id, year_id, pin_sum, total_cost) %>% 
  rename(adjust_pin = pin_sum,
         adjust_total = total_cost) 


increment_by_year <- merge(base_result, adjust_result , by = c("unique_id", "year_id"))

increment_by_year$incremental <- increment_by_year$adjust_total - increment_by_year$base_total

file.name <- paste0("Result_0706/Optimal/incremental_cost_year/",selected_country,"_increment_cost_2020_2030",".csv")
write.csv(increment_by_year, file.name)

increment_all_year <- rbind(increment_all_year, increment_by_year)

country.all.id <- colsplit(increment_by_year$unique_id,"_",names=c("Code","sub_id"))
# From unique_id to Code
increment_by_year$Code <- country.all.id$Code
increment_by_year$sub_id <- country.all.id$sub_id


country.all.sum <- increment_by_year %>% 
  group_by(Country, Region, year_id) %>% 
  summarize(sum_increment = sum(incremental))


# Benefit
benefits.country <- benefits.opt %>% 
  filter(Country == selected_country) 


country.all2 <- merge(x = country.all.sum, y = benefits.country[,c("Country", "year_id", "DALY.ave")], by = c("Country", "year_id"),all.x = T)


country.all2 <- country.all2 %>% 
  mutate(ICER = sum_increment / DALY.ave
         )

file.name <- paste0("Result_0706/Optimal/ICER_country_detail/",selected_country,"_ICER_2020_2030",".csv")
write.csv(country.all2, file.name)

final_all_ICER <- rbind(final_all_ICER, country.all2)

}

```

```{r}
file.name <- paste0("Result_0706/Optimal/All_TC_2030",".csv")
write.csv(final_all, file.name)

file.name <- paste0("Result_0706/Optimal/All_Intervention_2030",".csv")
write.csv(final_all_intervention, file.name)

file.name <- paste0("Result_0706/Optimal/All_ICER_2030",".csv")
write.csv(final_all_ICER, file.name)
```


```{r Table 2 generate}
file.name <- paste0("Result_0706/Optimal/All_Intervention_2030",".csv")
all <- read.csv(file.name)

all_int_base <- all %>% 
  filter(senario == "Baseline") %>% 
  group_by(Region) %>% 
  filter(is.na(total_cost) == F) %>% 
  summarize(total_cost_base = sum(total_cost))


all_int_ad <- all %>% 
  filter(senario == "Adjusted") %>% 
  group_by(Region) %>% 
  filter(is.na(total_cost) == F) %>% 
  summarize(total_cost_adjust = sum(total_cost))

all_int_dif <- merge(all_int_base, all_int_ad, by = c("Region"), all.x = T )

all_int_dif$increment <- all_int_dif$total_cost_adjust - all_int_dif$total_cost_base

sum_total_base <- sum(all_int_dif$total_cost_base)
sum_total_ad <- sum(all_int_dif$total_cost_adjust)
sum_total_increment <- sum(all_int_dif$increment)

all_int_dif$Region <- as.character(all_int_dif$Region)

All <- c("All", sum_total_base, sum_total_ad, sum_total_increment)

table2 <- rbind(all_int_dif,All)
#Numeric
table2$total_cost_base <- as.numeric(table2$total_cost_base)
table2$total_cost_adjust <- as.numeric(table2$total_cost_adjust)
table2$increment <- as.numeric(table2$increment)

table2[,2:4] <- round(table2[,2:4] / 1000000000,2)


table2 <- table2[c(4,1,2,7,6,3,5,8),]

write.csv(table2, "Result_0706/Table2.csv")
```


# Table2 (self harm): Based on ICER ranking
```{r data install}
load("NCD_data_0706/Optim.Out.m.rda")
# Data check
all.pin.opt <- all.pin.opt.m
dalys.opt <- dalys.opt.m

all.pin.opt$unique_id <- paste0(all.pin.opt$Code,"_",all.pin.opt$sub_id)

write.csv(all.pin.opt, "NCD_data_0706/From Will/pin_all_opt_m.csv")
write.csv(dalys.opt, "NCD_data_0706/From Will/NCD_benefits_opt_m.csv")

benefits.opt <- merge(y = dalys.opt, x = class, by.x = "Country", by.y = "location_name")
```

```{r data.frame development}
final_all <- data.frame(Code = character() ,
                        adjusted_uc = numeric(),
                        pin_sum= numeric(),
                        year_id =  numeric(),
                        total_cost = numeric(),
                        senario = character() ,
                        Country = character(),
                        Class = character(),
                        Region = character(),
                        stringsAsFactors=FALSE)


final_all_intervention <- data.frame(Code = character(),
                                     Intervention = character(),
                                     senario = character() ,
                                     Country = character(),
                                     adjusted_uc = numeric(),
                                     pin_sum = numeric(),
                                     total_cost = numeric(),
                                     Region = character(),
                                     stringsAsFactors=FALSE) 




final_all_ICER <- data.frame(Country = character(),
                             year_id = numeric(),
                             Region = character(),
                             sum_increment = numeric(),
                             life_years_gained = numeric(),
                             ICER = numeric()
)

increment_all_year      <- data.frame(
                             unique_id = character(),
                             year_id = numeric(),
                             Class = character(),
                             Region = character(),
                             adjusted_uc = numeric(),
                             base_pin = numeric(),
                             base_total = numeric(),
                             adjust_pin = numeric(),
                             adjust_total = numeric(),
                             increment = numeric()
)
```


```{r re-run}
# Calculate adjusted costs & total by interventions
i <- 1
c <- 1
n <- 1
y <- 1

UC_Years <- 2017  # The output year

for (c in 1:nrow(country_list)){
 
  selected_country <- as.character(country_list$Country[c])
  selected_country_code <- as.character(country_list$iso3[c])
  selected_country_category <- as.character(country_list$World_bank[c])
  selected_country_region <- as.character(country_list$NCD_region[c])
  
  country_class <- as.character(country_list[country_list$Country == selected_country,]$World_bank) 
# Adjusted UC install
# Adjustment database
  no <- nrow(uc)

  file.name <- paste0("Result_0706/UC/",selected_country,"_adjusted_uc_",UC_Years,".csv")
  adjusted_uc <- read.csv(file.name)
        
# Adjusted UC end 
     
    result.df <- adjusted_uc %>% select(unique_id)
    result.df2 <- adjusted_uc %>% select(unique_id)

    
# full data -----------------------
  country.pop <- all.pin.opt %>% 
  filter(location_name == selected_country)
    
  full.data <- merge.data.frame(x = country.pop, y = adjusted_uc[,c("unique_id", "Original.Unit.Cost", "Cost.adjustment", "Traded", "tradable_uc", "nontradable_uc", "adjusted_uc" )], by = "unique_id", all.x = T)

  full.data$total_cost <- full.data$pin * full.data$adjusted_uc
  
  file.name <- paste0("Result_0706/Optimal_self/All_pop_cost/",selected_country,"_all_by_intervention_year",".csv")
  write.csv(full.data, file.name)
  
    
# Baseline population in need------------------
for (y in 0:10){
  
##PIN by intervention
# pin_group = all code
pin_group <- all.pin.opt %>% 
  filter(location_name == selected_country,
         year_id == 2020 + y, 
         group == "Baseline") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

pin_group$year_id <- 2020 + y

uc_pin <- merge.data.frame(adjusted_uc, pin_group, by = "unique_id")

uc_pin <- uc_pin %>% 
  mutate(total_cost = adjusted_uc * pin_sum)

uc_pin_all <- if(y == 0) {
  uc_pin
} else {
  rbind(uc_pin_all, uc_pin)
}

result.df <- merge(result.df, uc_pin[,c("unique_id","total_cost")], by = "unique_id")

label <- paste0("cost_",2020+y)
names(result.df)[ which( names(result.df)=="total_cost" ) ] <- label
}

  
# By Interventions
final.df1_int <- result.df
final.df1_int$senario <- "Baseline"
final.df1_int$Country <- selected_country
final.df1_int$Class <- country_class
final.df1_int$Region <- selected_country_region

final.df1_int$total_cost <- apply(final.df1_int[,2:12],1,sum)

# Add unit cost
final.df1_int <- merge(final.df1_int, uc_pin[,c("unique_id", "adjusted_uc")] , by = "unique_id")

# Add pin
pin_code <- all.pin.opt %>% 
  filter(location_name == selected_country,
         group == "Baseline") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

final.df1_int <- merge(final.df1_int, pin_code[,c("unique_id", "pin_sum")], by = "unique_id")

 # final.df1_int <- final.df1_int %>%
 #   select(unique_id, senario, Country, adjusted_uc, pin_sum ,total_cost, Region)
 # 

# years
result.df1_long <- uc_pin_all

result.df1_long$senario <- "Baseline"
result.df1_long$Country <- selected_country
result.df1_long$Class <- country_class
result.df1_long$Region <- selected_country_region





#Adjustment-------------

for (y in 0:10){
#PIN by intervention

# pin_group = all code
pin_group <- all.pin.opt %>% 
  filter(location_name == selected_country,
         year_id == 2020 + y, 
         group == "Adjusted") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

pin_group$year_id <- 2020 + y

uc_pin <- merge.data.frame(adjusted_uc, pin_group, by = "unique_id")

uc_pin <- uc_pin %>% 
  mutate(total_cost = adjusted_uc * pin_sum)

uc_pin_all <- if(y == 0) {
  uc_pin
} else {
  rbind(uc_pin_all, uc_pin)
}

result.df2 <- merge(result.df2, uc_pin[,c("unique_id","total_cost")], by = "unique_id")

label <- paste0("cost_",2020+y)
names(result.df2)[ which( names(result.df2)=="total_cost" ) ] <- label

}

# By intervention & save

final.df2_int <- result.df2
final.df2_int$senario <- "Adjusted"
final.df2_int$Country <- selected_country
final.df2_int$Class <- country_class
final.df2_int$Region <- selected_country_region

final.df2_int$total_cost <- apply(final.df2_int[,2:12],1,sum)

# Add unit cost
final.df2_int <- merge(final.df2_int, uc_pin[,c("unique_id", "adjusted_uc")])

# Add pin
pin_code <- all.pin.opt %>% 
  filter(location_name == selected_country, 
         group == "Adjusted") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

final.df2_int <- merge(final.df2_int, pin_code[,c("unique_id", "pin_sum")])

# 
#  final.df2_int <- final.df2_int %>% 
#    select(Code, senario, Country, adjusted_uc, pin_sum ,total_cost, Region)
  
final_country_tc_int <- rbind(final.df1_int,final.df2_int)


#Final dataset by interventions-------------------
file.name <- paste0("Result_0706/Optimal_self/Total_cost_intervention/",selected_country,"_total_cost_2030_intervention",".csv")
write.csv(final_country_tc_int, file.name)

final_all_intervention <- rbind(final_all_intervention, final_country_tc_int)
#--------------------------------------------------

# By year
result.df2_long <- uc_pin_all

result.df2_long$senario <- "Adjusted"
result.df2_long$Country <- selected_country
result.df2_long$Class <- country_class
result.df2_long$Region <- selected_country_region

# Save
final_country_tc3 <- rbind(result.df1_long,result.df2_long)
file.name <- paste0("Result_0706/Optimal_self/Total_cost_year/",selected_country,"_total_cost_2030",".csv")
write.csv(final_country_tc3, file.name)

#Final dataset-------------------
  final_all <- rbind(final_all, final_country_tc3)

# ----------------------
# incremental cost by year and intervention
base_result <- result.df1_long %>% 
  filter(senario == "Baseline")%>% 
  select(unique_id, Country, Class, Region, year_id, adjusted_uc, pin_sum, total_cost) %>% 
  rename(base_pin = pin_sum,
         base_total = total_cost) 

adjust_result <- result.df2_long %>%
  filter(senario == "Adjusted") %>% 
  select(unique_id, year_id, pin_sum, total_cost) %>% 
  rename(adjust_pin = pin_sum,
         adjust_total = total_cost) 


increment_by_year <- merge(base_result, adjust_result , by = c("unique_id", "year_id"))

increment_by_year$incremental <- increment_by_year$adjust_total - increment_by_year$base_total

file.name <- paste0("Result_0706/Optimal_self/incremental_cost_year/",selected_country,"_increment_cost_2020_2030",".csv")
write.csv(increment_by_year, file.name)

increment_all_year <- rbind(increment_all_year, increment_by_year)

country.all.id <- colsplit(increment_by_year$unique_id,"_",names=c("Code","sub_id"))
# From unique_id to Code
increment_by_year$Code <- country.all.id$Code
increment_by_year$sub_id <- country.all.id$sub_id


country.all.sum <- increment_by_year %>% 
  group_by(Country, Region, year_id) %>% 
  summarize(sum_increment = sum(incremental))


# Benefit
benefits.country <- benefits.opt %>% 
  filter(Country == selected_country) 


country.all2 <- merge(x = country.all.sum, y = benefits.country[,c("Country", "year_id", "DALY.ave")], by = c("Country", "year_id"),all.x = T)


country.all2 <- country.all2 %>% 
  mutate(ICER = sum_increment / DALY.ave
         )

file.name <- paste0("Result_0706/Optimal_self/ICER_country_detail/",selected_country,"_ICER_2020_2030",".csv")
write.csv(country.all2, file.name)

final_all_ICER <- rbind(final_all_ICER, country.all2)

}

```

```{r}
file.name <- paste0("Result_0706/Optimal_self/All_TC_2030",".csv")
write.csv(final_all, file.name)

file.name <- paste0("Result_0706/Optimal_self/All_Intervention_2030",".csv")
write.csv(final_all_intervention, file.name)

file.name <- paste0("Result_0706/Optimal_self/All_ICER_2030",".csv")
write.csv(final_all_ICER, file.name)
```


```{r Table 2 generate}
file.name <- paste0("Result_0706/Optimal_self/All_Intervention_2030",".csv")
all <- read.csv(file.name)

all_int_base <- all %>% 
  filter(senario == "Baseline") %>% 
  group_by(Region) %>% 
  filter(is.na(total_cost) == F) %>% 
  summarize(total_cost_base = sum(total_cost))


all_int_ad <- all %>% 
  filter(senario == "Adjusted") %>% 
  group_by(Region) %>% 
  filter(is.na(total_cost) == F) %>% 
  summarize(total_cost_adjust = sum(total_cost))

all_int_dif <- merge(all_int_base, all_int_ad, by = c("Region"), all.x = T )

all_int_dif$increment <- all_int_dif$total_cost_adjust - all_int_dif$total_cost_base

sum_total_base <- sum(all_int_dif$total_cost_base)
sum_total_ad <- sum(all_int_dif$total_cost_adjust)
sum_total_increment <- sum(all_int_dif$increment)

all_int_dif$Region <- as.character(all_int_dif$Region)

All <- c("All", sum_total_base, sum_total_ad, sum_total_increment)

table2 <- rbind(all_int_dif,All)
#Numeric
table2$total_cost_base <- as.numeric(table2$total_cost_base)
table2$total_cost_adjust <- as.numeric(table2$total_cost_adjust)
table2$increment <- as.numeric(table2$increment)

table2[,2:4] <- round(table2[,2:4] / 1000000000,2)


table2 <- table2[c(4,1,2,7,6,3,5,8),]

write.csv(table2, "Result_0706/Table2_self.csv")
```

# Data for Adrian
```{r}
file.name <- paste0("Result_0706/Optimal/All_Intervention_2030",".csv")
all <- read.csv(file.name)

all

sum_country <- all %>% 
  group_by(Country, Region, Class, senario) %>% 
  summarize(total_cost_2020 = sum(cost_2020),
            total_cost_2021 = sum(cost_2021),
            total_cost_2022 = sum(cost_2022),
            total_cost_2023 = sum(cost_2023),
            total_cost_2024 = sum(cost_2024),
            total_cost_2025 = sum(cost_2025),
            total_cost_2026 = sum(cost_2026),
            total_cost_2027 = sum(cost_2027),
            total_cost_2028 = sum(cost_2028),
            total_cost_2029 = sum(cost_2029),
            total_cost_2030 = sum(cost_2030),
            total_cost_all = sum(total_cost))


class <- read.csv("NCD_data_0706/Country_groupings.csv")
country_list <- class %>% 
  filter(World_bank == "LIC" | World_bank == "LMIC"| World_bank == "UMIC") %>% 
  filter(NCD_region %in% c("Latin America and Caribbean",
         "Central and Eastern Europe",
         "Central Asia, Middle East and North Africa",
         "Sub-Saharan Africa",
         "South Asia",
         "East and South East Asia",
         "Oceania")) %>% 
  select(Country, iso3)


sum_country2 <- merge(country_list, sum_country, by = "Country")

write.csv(sum_country2, "Result_0706/Total_cost_NCD.csv")
```

```{r}
file.name <- paste0("Result_0706/Optimal_self/All_Intervention_2030",".csv")
all <- read.csv(file.name)

all

sum_country <- all %>% 
  group_by(Country, Region, Class, senario) %>% 
  summarize(total_cost_2020 = sum(cost_2020),
            total_cost_2021 = sum(cost_2021),
            total_cost_2022 = sum(cost_2022),
            total_cost_2023 = sum(cost_2023),
            total_cost_2024 = sum(cost_2024),
            total_cost_2025 = sum(cost_2025),
            total_cost_2026 = sum(cost_2026),
            total_cost_2027 = sum(cost_2027),
            total_cost_2028 = sum(cost_2028),
            total_cost_2029 = sum(cost_2029),
            total_cost_2030 = sum(cost_2030),
            total_cost_all = sum(total_cost))


class <- read.csv("NCD_data_0706/Country_groupings.csv")
country_list <- class %>% 
  filter(World_bank == "LIC" | World_bank == "LMIC"| World_bank == "UMIC") %>% 
  filter(NCD_region %in% c("Latin America and Caribbean",
         "Central and Eastern Europe",
         "Central Asia, Middle East and North Africa",
         "Sub-Saharan Africa",
         "South Asia",
         "East and South East Asia",
         "Oceania")) %>% 
  select(Country, iso3)


sum_country2 <- merge(country_list, sum_country, by = "Country")

write.csv(sum_country2, "Result_0706/Total_cost_self.csv")
```



# Additional table
```{r additional table}
file.name <- paste0("Result_0706/Optimal/All_Intervention_2030",".csv")
all <- read.csv(file.name)

class <- read.csv("NCD_data_0706/Country_groupings.csv")
country_list <- class %>% 
  filter(World_bank == "LIC" | World_bank == "LMIC"| World_bank == "UMIC") %>% 
  filter(NCD_region %in% c("Latin America and Caribbean",
         "Central and Eastern Europe",
         "Central Asia, Middle East and North Africa",
         "Sub-Saharan Africa",
         "South Asia",
         "East and South East Asia",
         "Oceania")) %>% 
  select(Country, iso3)


GNI <- read.csv("GNI_adjustment/GNI_WB_USD_2017_re2.csv", stringsAsFactors=F) %>% 
  filter(Country %in% country_list$Country) %>% 
  select(Country, X2017)


pop <- read.csv("NCD_data_0706/IHME_GBD_2017_POP_2015_2017_Y2018M11D08.csv", stringsAsFactors=F) %>% 
  filter(year_id == 2017)

pop2017 <- pop %>% 
  filter(age_group_name == "All Ages") %>%
  filter(sex_name == "Both") %>% 
  filter(location_id != 533) %>%  #Exclude same name of Georgia
  filter(location_name %in% country_list$Country) %>% 
  select(location_name, val) %>% 
  rename(Country = location_name)


sum_country <- all %>% 
  filter(senario == "Adjusted") %>% 
  group_by(Country, Region, Class) %>% 
  summarize(total_cost_2020 = sum(cost_2020),
            total_cost_2021 = sum(cost_2021),
            total_cost_2022 = sum(cost_2022),
            total_cost_2023 = sum(cost_2023),
            total_cost_2024 = sum(cost_2024),
            total_cost_2025 = sum(cost_2025),
            total_cost_2026 = sum(cost_2026),
            total_cost_2027 = sum(cost_2027),
            total_cost_2028 = sum(cost_2028),
            total_cost_2029 = sum(cost_2029),
            total_cost_2030 = sum(cost_2030),
            total_cost_all = sum(total_cost))





sum_country <- merge(sum_country, country_list, by = "Country")
sum_country <- merge(sum_country, GNI, by = "Country")
sum_country <- merge(sum_country, pop2017, by = "Country")




sum_country2 <- sum_country %>% 
  select(
    Country,
    iso3,
    Region,
    Class,
    X2017,
    val,
    total_cost_2020, 
    total_cost_2021,
    total_cost_2022,
    total_cost_2023,
    total_cost_2024,
    total_cost_2025,
    total_cost_2026,
    total_cost_2027,
    total_cost_2028,
    total_cost_2029,
    total_cost_2030,
    total_cost_all
  ) %>% 
  rename(
    GNI_2017 = "X2017",
    Baseline_pop = "val"
  )

write.csv(sum_country2, "Result_0706/Additional_table.csv")

```

# Table 3: ICER 
```{r}
load("NCD_data_0706/icer_rank_output.rda")

all.pin <- all.pin %>% 
  mutate(case_volume = pin / Coverage,
         unique_id = paste0(Code,"_",sub_id)
)

sum.pin <- all.pin %>% 
  group_by(Code, year_id) %>% 
  summarize(sum_volume = sum(case_volume)) %>% 
  filter(year_id == 2020)

  
# total population
pop <- read.csv("NCD_data_0706/Pop2020.csv")
total_pop <- sum(pop$Population)

sum.pin$total.pop <- total_pop

sum.pin2 <- sum.pin %>% 
  mutate(rate = (sum_volume / total.pop)*100000) %>% 
  rename(PIN = sum_volume,
         "total population" = total.pop,
         "Case volume per 100,000 pop" = rate)

write.csv(sum.pin2, "Result_0706/table3.csv")
```

# Append table A2 
```{r}
lc <- read.csv("Result_0706/All/Incremental_cost.csv")

lc$sum <- apply(lc[,3:13], 1, sum)
lc$id <- NA

i <- 1
c <- strsplit(as.character(lc$unique_id), "_")

for (i in 1:49){
 id <- c[[i]] 
 lc$id[i] <- id
}

lc_sum <- lc %>% 
  select(unique_id, sum, id)


lc_sum <- lc_sum %>% group_by(id) %>% 
  summarize(sum_ly = sum(sum))

write.csv(lc_sum, "Result_0706/Append_tableA2_cost.csv")
```



# Appendix tables A10

```{r data install}
load("NCD_data_0706/Optim.Out95.rda")
# Data check
all.pin.opt <- all.pin.opt95
dalys.opt <- dalys.opt95

all.pin.opt$unique_id <- paste0(all.pin.opt$Code,"_",all.pin.opt$sub_id)

write.csv(all.pin.opt, "NCD_data_0706/From Will/pin_all_opt95.csv")
write.csv(dalys.opt, "NCD_data_0706/From Will/NCD_benefits_opt95.csv")

benefits.opt <- merge(y = dalys.opt, x = class, by.x = "Country", by.y = "location_name")
```

```{r data.frame development}
final_all <- data.frame(Code = character() ,
                        adjusted_uc = numeric(),
                        pin_sum= numeric(),
                        year_id =  numeric(),
                        total_cost = numeric(),
                        senario = character() ,
                        Country = character(),
                        Class = character(),
                        Region = character(),
                        stringsAsFactors=FALSE)


final_all_intervention <- data.frame(Code = character(),
                                     Intervention = character(),
                                     senario = character() ,
                                     Country = character(),
                                     adjusted_uc = numeric(),
                                     pin_sum = numeric(),
                                     total_cost = numeric(),
                                     Region = character(),
                                     stringsAsFactors=FALSE) 




final_all_ICER <- data.frame(Country = character(),
                             year_id = numeric(),
                             Region = character(),
                             sum_increment = numeric(),
                             life_years_gained = numeric(),
                             ICER = numeric()
)

increment_all_year      <- data.frame(
                             unique_id = character(),
                             year_id = numeric(),
                             Class = character(),
                             Region = character(),
                             adjusted_uc = numeric(),
                             base_pin = numeric(),
                             base_total = numeric(),
                             adjust_pin = numeric(),
                             adjust_total = numeric(),
                             increment = numeric()
)
```


```{r re-run}
# Calculate adjusted costs & total by interventions
i <- 1
c <- 1
n <- 1
y <- 1

UC_Years <- 2017  # The output year

for (c in 1:nrow(country_list)){
 
  selected_country <- as.character(country_list$Country[c])
  selected_country_code <- as.character(country_list$iso3[c])
  selected_country_category <- as.character(country_list$World_bank[c])
  selected_country_region <- as.character(country_list$NCD_region[c])
  
  country_class <- as.character(country_list[country_list$Country == selected_country,]$World_bank) 
# Adjusted UC install
# Adjustment database
  no <- nrow(uc)
  file.name <- paste0("Result_0706/UC/",selected_country,"_adjusted_uc_",UC_Years,".csv")
  adjusted_uc <- read.csv(file.name)
        
# Adjusted UC end 
     
    result.df <- adjusted_uc %>% select(unique_id)
    result.df2 <- adjusted_uc %>% select(unique_id)

    
# full data -----------------------
  country.pop <- all.pin.opt %>% 
  filter(location_name == selected_country)
    
  full.data <- merge.data.frame(x = country.pop, y = adjusted_uc[,c("unique_id", "Original.Unit.Cost", "Cost.adjustment", "Traded", "tradable_uc", "nontradable_uc", "adjusted_uc" )], by = "unique_id", all.x = T)

  full.data$total_cost <- full.data$pin * full.data$adjusted_uc
  
  file.name <- paste0("Result_0706/Optimal_95/All_pop_cost/",selected_country,"_all_by_intervention_year",".csv")
  write.csv(full.data, file.name)
  
    
# Baseline population in need------------------
for (y in 0:10){
  
##PIN by intervention
# pin_group = all code
pin_group <- all.pin.opt %>% 
  filter(location_name == selected_country,
         year_id == 2020 + y, 
         group == "Baseline") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

pin_group$year_id <- 2020 + y

uc_pin <- merge.data.frame(adjusted_uc, pin_group, by = "unique_id")

uc_pin <- uc_pin %>% 
  mutate(total_cost = adjusted_uc * pin_sum)

uc_pin_all <- if(y == 0) {
  uc_pin
} else {
  rbind(uc_pin_all, uc_pin)
}

result.df <- merge(result.df, uc_pin[,c("unique_id","total_cost")], by = "unique_id")

label <- paste0("cost_",2020+y)
names(result.df)[ which( names(result.df)=="total_cost" ) ] <- label
}

  
# By Interventions
final.df1_int <- result.df
final.df1_int$senario <- "Baseline"
final.df1_int$Country <- selected_country
final.df1_int$Class <- country_class
final.df1_int$Region <- selected_country_region

final.df1_int$total_cost <- apply(final.df1_int[,2:12],1,sum)

# Add unit cost
final.df1_int <- merge(final.df1_int, uc_pin[,c("unique_id", "adjusted_uc")] , by = "unique_id")

# Add pin
pin_code <- all.pin.opt %>% 
  filter(location_name == selected_country,
         group == "Baseline") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

final.df1_int <- merge(final.df1_int, pin_code[,c("unique_id", "pin_sum")], by = "unique_id")

 # final.df1_int <- final.df1_int %>%
 #   select(unique_id, senario, Country, adjusted_uc, pin_sum ,total_cost, Region)
 # 

# years
result.df1_long <- uc_pin_all

result.df1_long$senario <- "Baseline"
result.df1_long$Country <- selected_country
result.df1_long$Class <- country_class
result.df1_long$Region <- selected_country_region





#Adjustment-------------

for (y in 0:10){
#PIN by intervention

# pin_group = all code
pin_group <- all.pin.opt %>% 
  filter(location_name == selected_country,
         year_id == 2020 + y, 
         group == "Adjusted") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

pin_group$year_id <- 2020 + y

uc_pin <- merge.data.frame(adjusted_uc, pin_group, by = "unique_id")

uc_pin <- uc_pin %>% 
  mutate(total_cost = adjusted_uc * pin_sum)

uc_pin_all <- if(y == 0) {
  uc_pin
} else {
  rbind(uc_pin_all, uc_pin)
}

result.df2 <- merge(result.df2, uc_pin[,c("unique_id","total_cost")], by = "unique_id")

label <- paste0("cost_",2020+y)
names(result.df2)[ which( names(result.df2)=="total_cost" ) ] <- label

}

# By intervention & save

final.df2_int <- result.df2
final.df2_int$senario <- "Adjusted"
final.df2_int$Country <- selected_country
final.df2_int$Class <- country_class
final.df2_int$Region <- selected_country_region

final.df2_int$total_cost <- apply(final.df2_int[,2:12],1,sum)

# Add unit cost
final.df2_int <- merge(final.df2_int, uc_pin[,c("unique_id", "adjusted_uc")])

# Add pin
pin_code <- all.pin.opt %>% 
  filter(location_name == selected_country, 
         group == "Adjusted") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

final.df2_int <- merge(final.df2_int, pin_code[,c("unique_id", "pin_sum")])

# 
#  final.df2_int <- final.df2_int %>% 
#    select(Code, senario, Country, adjusted_uc, pin_sum ,total_cost, Region)
  
final_country_tc_int <- rbind(final.df1_int,final.df2_int)


#Final dataset by interventions-------------------
file.name <- paste0("Result_0706/Optimal_95/Total_cost_intervention/",selected_country,"_total_cost_2030_intervention",".csv")
write.csv(final_country_tc_int, file.name)

final_all_intervention <- rbind(final_all_intervention, final_country_tc_int)
#--------------------------------------------------

# By year
result.df2_long <- uc_pin_all

result.df2_long$senario <- "Adjusted"
result.df2_long$Country <- selected_country
result.df2_long$Class <- country_class
result.df2_long$Region <- selected_country_region

# Save
final_country_tc3 <- rbind(result.df1_long,result.df2_long)
file.name <- paste0("Result_0706/Optimal_95/Total_cost_year/",selected_country,"_total_cost_2030",".csv")
write.csv(final_country_tc3, file.name)

#Final dataset-------------------
  final_all <- rbind(final_all, final_country_tc3)

# ----------------------
# incremental cost by year and intervention
base_result <- result.df1_long %>% 
  filter(senario == "Baseline")%>% 
  select(unique_id, Country, Class, Region, year_id, adjusted_uc, pin_sum, total_cost) %>% 
  rename(base_pin = pin_sum,
         base_total = total_cost) 

adjust_result <- result.df2_long %>%
  filter(senario == "Adjusted") %>% 
  select(unique_id, year_id, pin_sum, total_cost) %>% 
  rename(adjust_pin = pin_sum,
         adjust_total = total_cost) 


increment_by_year <- merge(base_result, adjust_result , by = c("unique_id", "year_id"))

increment_by_year$incremental <- increment_by_year$adjust_total - increment_by_year$base_total

file.name <- paste0("Result_0706/Optimal_95/incremental_cost_year/",selected_country,"_increment_cost_2020_2030",".csv")
write.csv(increment_by_year, file.name)

increment_all_year <- rbind(increment_all_year, increment_by_year)

country.all.id <- colsplit(increment_by_year$unique_id,"_",names=c("Code","sub_id"))
# From unique_id to Code
increment_by_year$Code <- country.all.id$Code
increment_by_year$sub_id <- country.all.id$sub_id


country.all.sum <- increment_by_year %>% 
  group_by(Country, Region, year_id) %>% 
  summarize(sum_increment = sum(incremental))


# Benefit
benefits.country <- benefits.opt %>% 
  filter(Country == selected_country) 


country.all2 <- merge(x = country.all.sum, y = benefits.country[,c("Country", "year_id", "DALY.ave")], by = c("Country", "year_id"),all.x = T)


country.all2 <- country.all2 %>% 
  mutate(ICER = sum_increment / DALY.ave
         )

file.name <- paste0("Result_0706/Optimal_95/ICER_country_detail/",selected_country,"_ICER_2020_2030",".csv")
write.csv(country.all2, file.name)

final_all_ICER <- rbind(final_all_ICER, country.all2)

}

```

```{r}
file.name <- paste0("Result_0706/Optimal_95/All_TC_2030",".csv")
write.csv(final_all, file.name)

file.name <- paste0("Result_0706/Optimal_95/All_Intervention_2030",".csv")
write.csv(final_all_intervention, file.name)

file.name <- paste0("Result_0706/Optimal_95/All_ICER_2030",".csv")
write.csv(final_all_ICER, file.name)
```


```{r Table 2 generate}
file.name <- paste0("Result_0706/Optimal_95/All_Intervention_2030",".csv")
all <- read.csv(file.name)

all_int_base <- all %>% 
  filter(senario == "Baseline") %>% 
  group_by(Region) %>% 
  filter(is.na(total_cost) == F) %>% 
  summarize(total_cost_base = sum(total_cost))


all_int_ad <- all %>% 
  filter(senario == "Adjusted") %>% 
  group_by(Region) %>% 
  filter(is.na(total_cost) == F) %>% 
  summarize(total_cost_adjust = sum(total_cost))

all_int_dif <- merge(all_int_base, all_int_ad, by = c("Region"), all.x = T )

all_int_dif$increment <- all_int_dif$total_cost_adjust - all_int_dif$total_cost_base

sum_total_base <- sum(all_int_dif$total_cost_base)
sum_total_ad <- sum(all_int_dif$total_cost_adjust)
sum_total_increment <- sum(all_int_dif$increment)

all_int_dif$Region <- as.character(all_int_dif$Region)

All <- c("All", sum_total_base, sum_total_ad, sum_total_increment)

table2 <- rbind(all_int_dif,All)
#Numeric
table2$total_cost_base <- as.numeric(table2$total_cost_base)
table2$total_cost_adjust <- as.numeric(table2$total_cost_adjust)
table2$increment <- as.numeric(table2$increment)

table2[,2:4] <- round(table2[,2:4] / 1000000000,2)


table2 <- table2[c(4,1,2,7,6,3,5,8),]

write.csv(table2, "Result_0706/Append_A10.csv")
```





# Appendix tables A8

```{r data install}
load("NCD_data_0706/Optim.Out.noTA.rda")
# Data check
all.pin.opt <- all.pin.opt.noTA
dalys.opt <- dalys.opt.noTA

all.pin.opt$unique_id <- paste0(all.pin.opt$Code,"_",all.pin.opt$sub_id)

#write.csv(all.pin.opt, "NCD_data_0706/From Will/pin_all_opt.noTA.csv")
#write.csv(dalys.opt, "NCD_data_0706/From Will/NCD_benefits_opt.noTA.csv")

benefits.opt <- merge(y = dalys.opt, x = class, by.x = "Country", by.y = "location_name")
```

```{r data.frame development}
final_all <- data.frame(Code = character() ,
                        adjusted_uc = numeric(),
                        pin_sum= numeric(),
                        year_id =  numeric(),
                        total_cost = numeric(),
                        senario = character() ,
                        Country = character(),
                        Class = character(),
                        Region = character(),
                        stringsAsFactors=FALSE)


final_all_intervention <- data.frame(Code = character(),
                                     Intervention = character(),
                                     senario = character() ,
                                     Country = character(),
                                     adjusted_uc = numeric(),
                                     pin_sum = numeric(),
                                     total_cost = numeric(),
                                     Region = character(),
                                     stringsAsFactors=FALSE) 




final_all_ICER <- data.frame(Country = character(),
                             year_id = numeric(),
                             Region = character(),
                             sum_increment = numeric(),
                             life_years_gained = numeric(),
                             ICER = numeric()
)

increment_all_year      <- data.frame(
                             unique_id = character(),
                             year_id = numeric(),
                             Class = character(),
                             Region = character(),
                             adjusted_uc = numeric(),
                             base_pin = numeric(),
                             base_total = numeric(),
                             adjust_pin = numeric(),
                             adjust_total = numeric(),
                             increment = numeric()
)
```


```{r re-run}
# Calculate adjusted costs & total by interventions
i <- 1
c <- 1
n <- 1
y <- 1

UC_Years <- 2017  # The output year

for (c in 1:nrow(country_list)){
 
  selected_country <- as.character(country_list$Country[c])
  selected_country_code <- as.character(country_list$iso3[c])
  selected_country_category <- as.character(country_list$World_bank[c])
  selected_country_region <- as.character(country_list$NCD_region[c])
  
  country_class <- as.character(country_list[country_list$Country == selected_country,]$World_bank) 
# Adjusted UC install
# Adjustment database
  no <- nrow(uc)
  file.name <- paste0("Result_0706/UC/",selected_country,"_adjusted_uc_",UC_Years,".csv")
  adjusted_uc <- read.csv(file.name)
        
# Adjusted UC end 
     
    result.df <- adjusted_uc %>% select(unique_id)
    result.df2 <- adjusted_uc %>% select(unique_id)

    
# full data -----------------------
  country.pop <- all.pin.opt %>% 
  filter(location_name == selected_country)
    
  full.data <- merge.data.frame(x = country.pop, y = adjusted_uc[,c("unique_id", "Original.Unit.Cost", "Cost.adjustment", "Traded", "tradable_uc", "nontradable_uc", "adjusted_uc" )], by = "unique_id", all.x = T)

  full.data$total_cost <- full.data$pin * full.data$adjusted_uc
  
  file.name <- paste0("Result_0706/Optimal_noTA/All_pop_cost/",selected_country,"_all_by_intervention_year",".csv")
  write.csv(full.data, file.name)
  
    
# Baseline population in need------------------
for (y in 0:10){
  
##PIN by intervention
# pin_group = all code
pin_group <- all.pin.opt %>% 
  filter(location_name == selected_country,
         year_id == 2020 + y, 
         group == "Baseline") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

pin_group$year_id <- 2020 + y

uc_pin <- merge.data.frame(adjusted_uc, pin_group, by = "unique_id")

uc_pin <- uc_pin %>% 
  mutate(total_cost = adjusted_uc * pin_sum)

uc_pin_all <- if(y == 0) {
  uc_pin
} else {
  rbind(uc_pin_all, uc_pin)
}

result.df <- merge(result.df, uc_pin[,c("unique_id","total_cost")], by = "unique_id")

label <- paste0("cost_",2020+y)
names(result.df)[ which( names(result.df)=="total_cost" ) ] <- label
}

  
# By Interventions
final.df1_int <- result.df
final.df1_int$senario <- "Baseline"
final.df1_int$Country <- selected_country
final.df1_int$Class <- country_class
final.df1_int$Region <- selected_country_region

final.df1_int$total_cost <- apply(final.df1_int[,2:12],1,sum)

# Add unit cost
final.df1_int <- merge(final.df1_int, uc_pin[,c("unique_id", "adjusted_uc")] , by = "unique_id")

# Add pin
pin_code <- all.pin.opt %>% 
  filter(location_name == selected_country,
         group == "Baseline") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

final.df1_int <- merge(final.df1_int, pin_code[,c("unique_id", "pin_sum")], by = "unique_id")

 # final.df1_int <- final.df1_int %>%
 #   select(unique_id, senario, Country, adjusted_uc, pin_sum ,total_cost, Region)
 # 

# years
result.df1_long <- uc_pin_all

result.df1_long$senario <- "Baseline"
result.df1_long$Country <- selected_country
result.df1_long$Class <- country_class
result.df1_long$Region <- selected_country_region





#Adjustment-------------

for (y in 0:10){
#PIN by intervention

# pin_group = all code
pin_group <- all.pin.opt %>% 
  filter(location_name == selected_country,
         year_id == 2020 + y, 
         group == "Adjusted") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

pin_group$year_id <- 2020 + y

uc_pin <- merge.data.frame(adjusted_uc, pin_group, by = "unique_id")

uc_pin <- uc_pin %>% 
  mutate(total_cost = adjusted_uc * pin_sum)

uc_pin_all <- if(y == 0) {
  uc_pin
} else {
  rbind(uc_pin_all, uc_pin)
}

result.df2 <- merge(result.df2, uc_pin[,c("unique_id","total_cost")], by = "unique_id")

label <- paste0("cost_",2020+y)
names(result.df2)[ which( names(result.df2)=="total_cost" ) ] <- label

}

# By intervention & save

final.df2_int <- result.df2
final.df2_int$senario <- "Adjusted"
final.df2_int$Country <- selected_country
final.df2_int$Class <- country_class
final.df2_int$Region <- selected_country_region

final.df2_int$total_cost <- apply(final.df2_int[,2:12],1,sum)

# Add unit cost
final.df2_int <- merge(final.df2_int, uc_pin[,c("unique_id", "adjusted_uc")])

# Add pin
pin_code <- all.pin.opt %>% 
  filter(location_name == selected_country, 
         group == "Adjusted") %>% 
  group_by(unique_id) %>% 
  summarize(pin_sum = sum(pin))

final.df2_int <- merge(final.df2_int, pin_code[,c("unique_id", "pin_sum")])

# 
#  final.df2_int <- final.df2_int %>% 
#    select(Code, senario, Country, adjusted_uc, pin_sum ,total_cost, Region)
  
final_country_tc_int <- rbind(final.df1_int,final.df2_int)


#Final dataset by interventions-------------------
file.name <- paste0("Result_0706/Optimal_noTA/Total_cost_intervention/",selected_country,"_total_cost_2030_intervention",".csv")
write.csv(final_country_tc_int, file.name)

final_all_intervention <- rbind(final_all_intervention, final_country_tc_int)
#--------------------------------------------------

# By year
result.df2_long <- uc_pin_all

result.df2_long$senario <- "Adjusted"
result.df2_long$Country <- selected_country
result.df2_long$Class <- country_class
result.df2_long$Region <- selected_country_region

# Save
final_country_tc3 <- rbind(result.df1_long,result.df2_long)
file.name <- paste0("Result_0706/Optimal_noTA/Total_cost_year/",selected_country,"_total_cost_2030",".csv")
write.csv(final_country_tc3, file.name)

#Final dataset-------------------
  final_all <- rbind(final_all, final_country_tc3)

# ----------------------
# incremental cost by year and intervention
base_result <- result.df1_long %>% 
  filter(senario == "Baseline")%>% 
  select(unique_id, Country, Class, Region, year_id, adjusted_uc, pin_sum, total_cost) %>% 
  rename(base_pin = pin_sum,
         base_total = total_cost) 

adjust_result <- result.df2_long %>%
  filter(senario == "Adjusted") %>% 
  select(unique_id, year_id, pin_sum, total_cost) %>% 
  rename(adjust_pin = pin_sum,
         adjust_total = total_cost) 


increment_by_year <- merge(base_result, adjust_result , by = c("unique_id", "year_id"))

increment_by_year$incremental <- increment_by_year$adjust_total - increment_by_year$base_total

file.name <- paste0("Result_0706/Optimal_noTA/incremental_cost_year/",selected_country,"_increment_cost_2020_2030",".csv")
write.csv(increment_by_year, file.name)

increment_all_year <- rbind(increment_all_year, increment_by_year)

country.all.id <- colsplit(increment_by_year$unique_id,"_",names=c("Code","sub_id"))
# From unique_id to Code
increment_by_year$Code <- country.all.id$Code
increment_by_year$sub_id <- country.all.id$sub_id


country.all.sum <- increment_by_year %>% 
  group_by(Country, Region, year_id) %>% 
  summarize(sum_increment = sum(incremental))


# Benefit
benefits.country <- benefits.opt %>% 
  filter(Country == selected_country) 


country.all2 <- merge(x = country.all.sum, y = benefits.country[,c("Country", "year_id", "DALY.ave")], by = c("Country", "year_id"),all.x = T)


country.all2 <- country.all2 %>% 
  mutate(ICER = sum_increment / DALY.ave
         )

file.name <- paste0("Result_0706/Optimal_noTA/ICER_country_detail/",selected_country,"_ICER_2020_2030",".csv")
write.csv(country.all2, file.name)

final_all_ICER <- rbind(final_all_ICER, country.all2)

}

```

```{r}
file.name <- paste0("Result_0706/Optimal_noTA/All_TC_2030",".csv")
write.csv(final_all, file.name)

file.name <- paste0("Result_0706/Optimal_noTA/All_Intervention_2030",".csv")
write.csv(final_all_intervention, file.name)

file.name <- paste0("Result_0706/Optimal_noTA/All_ICER_2030",".csv")
write.csv(final_all_ICER, file.name)
```


```{r Table 2 generate}
file.name <- paste0("Result_0706/Optimal_noTA/All_Intervention_2030",".csv")
all <- read.csv(file.name)

all_int_base <- all %>% 
  filter(senario == "Baseline") %>% 
  group_by(Region) %>% 
  filter(is.na(total_cost) == F) %>% 
  summarize(total_cost_base = sum(total_cost))


all_int_ad <- all %>% 
  filter(senario == "Adjusted") %>% 
  group_by(Region) %>% 
  filter(is.na(total_cost) == F) %>% 
  summarize(total_cost_adjust = sum(total_cost))

all_int_dif <- merge(all_int_base, all_int_ad, by = c("Region"), all.x = T )

all_int_dif$increment <- all_int_dif$total_cost_adjust - all_int_dif$total_cost_base

sum_total_base <- sum(all_int_dif$total_cost_base)
sum_total_ad <- sum(all_int_dif$total_cost_adjust)
sum_total_increment <- sum(all_int_dif$increment)

all_int_dif$Region <- as.character(all_int_dif$Region)

All <- c("All", sum_total_base, sum_total_ad, sum_total_increment)

table2 <- rbind(all_int_dif,All)
#Numeric
table2$total_cost_base <- as.numeric(table2$total_cost_base)
table2$total_cost_adjust <- as.numeric(table2$total_cost_adjust)
table2$increment <- as.numeric(table2$increment)

table2[,2:4] <- round(table2[,2:4] / 1000000000,2)


table2 <- table2[c(4,1,2,7,6,3,5,8),]

write.csv(table2, "Result_0706/Append_A8.csv")
```
